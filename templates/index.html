<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cosmetic Ingredient Extractor avec Cropper.js</title>
  <link
    href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <style>
    body {
      font-family: 'Manrope', 'Noto Sans', sans-serif;
    }
    .cropper-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .cropper-modal.active {
      display: flex;
    }
    .cropper-container {
      max-width: 90vw;
      max-height: 80vh;
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .cropper-image {
      max-width: 100%;
      max-height: 60vh;
      display: block;
      margin: 0 auto;
      border-radius: 6px;
    }
  </style>
</head>
<body class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden">
  <div class="layout-container flex h-full grow flex-col">
    <header
      class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f2f0f4] px-4 sm:px-10 py-3"
    >
      <div class="flex items-center gap-2 sm:gap-4 text-[#141118]">
        <h2
          class="text-[#141118] text-base sm:text-lg font-bold leading-tight tracking-[-0.015em] header-title"
        >
          Cosmetic Ingredient Extractor
        </h2>
      </div>
    </header>
    <div class="px-4 sm:px-8 md:px-16 lg:px-40 flex flex-1 justify-center py-5">
      <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
        <h2
          class="text-[#141118] tracking-tight text-xl sm:text-2xl md:text-[28px] font-bold leading-tight px-4 text-center pb-3 pt-5"
        >
          Extract Cosmetic Ingredients
        </h2>
        <p
          class="text-[#141118] text-sm sm:text-base font-normal leading-normal pb-3 pt-1 px-4 text-center"
        >
          Upload an image of a cosmetic product's ingredient list to extract the
          ingredients in INCI format.
        </p>

        <form
          id="uploadForm"
          method="POST"
          enctype="multipart/form-data"
          class="flex flex-col p-4"
        >
          <div
            id="dropZone"
            class="drop-zone flex flex-col items-center gap-4 rounded-xl border-2 border-dashed border-[#e0dce5] px-6 py-8 sm:px-8 sm:py-10 cursor-pointer"
          >
            <p id="dropText" class="drop-text text-center">
              Drag and drop an image here, or use the buttons below
            </p>
            <input
              type="file"
              id="imageInput"
              accept="image/*"
              capture="environment"
              class="hidden"
            />
            <div
              id="previewContainer"
              class="preview-container mt-6 w-full hidden"
            >
              <img
                id="imagePreview"
                alt="Aperçu de l'image"
                class="max-h-[150px] w-full object-contain rounded-lg shadow-md"
                src="#"
              />
            </div>
          </div>

          <!-- Champ caché pour la donnée base64 de l'image cropée -->
          <input type="hidden" name="croppedImageData" id="croppedImageData" />

          <div
            class="button-group flex justify-center items-center gap-3 px-4 py-3 max-w-[960px] mx-auto"
          >
            <button
              id="uploadButton"
              type="button"
              class="flex min-w-[120px] cursor-pointer items-center justify-center rounded-full h-10 px-4 bg-[#f2f0f4] text-[#141118] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              Upload Image
            </button>
            <button
              id="takePhotoButton"
              type="button"
              class="flex min-w-[120px] cursor-pointer items-center justify-center rounded-full h-10 px-4 bg-[#f2f0f4] text-[#141118] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              Take a Photo
            </button>
            <button
              id="extractButton"
              type="submit"
              class="flex min-w-[120px] cursor-pointer items-center justify-center rounded-full h-10 px-4 bg-[#9642ea] text-white text-sm font-bold leading-normal tracking-[0.015em] opacity-50 cursor-not-allowed"
              disabled
            >
              Extract Ingredients
            </button>
            <button
              id="clearImageButton"
              type="button"
              class="flex min-w-[120px] cursor-pointer items-center justify-center rounded-full h-10 px-4 bg-[#f2f0f4] text-[#141118] text-sm font-bold leading-normal tracking-[0.015em]"
            >
              Clear Image
            </button>
          </div>
          <p
            id="feedbackMessage"
            class="feedback-message hidden text-center text-sm font-normal leading-normal pb-3 pt-1 px-4 text-[#756388]"
          ></p>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Cropper -->
  <div id="cropModal" class="cropper-modal" tabindex="-1" role="dialog" aria-modal="true">
    <div class="cropper-container">
      <img id="cropperImage" src="" alt="Cropper" class="cropper-image" />
      <div class="flex justify-end gap-4 mt-3">
        <button
          id="cropCancel"
          type="button"
          class="rounded-full px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold"
        >
          Annuler
        </button>
        <button
          id="cropConfirm"
          type="button"
          class="rounded-full px-4 py-2 bg-purple-700 hover:bg-purple-800 text-white font-semibold"
        >
          Valider
        </button>
      </div>
    </div>
  </div>

  <script>
    let cropper = null;
    let currentFile = null;

    const imageInput = document.getElementById('imageInput');
    const dropZone = document.getElementById('dropZone');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const uploadButton = document.getElementById('uploadButton');
    const takePhotoButton = document.getElementById('takePhotoButton');
    const clearImageButton = document.getElementById('clearImageButton');
    const cropModal = document.getElementById('cropModal');
    const cropperImage = document.getElementById('cropperImage');
    const cropCancel = document.getElementById('cropCancel');
    const cropConfirm = document.getElementById('cropConfirm');
    const feedbackMessage = document.getElementById('feedbackMessage');
    const extractButton = document.getElementById('extractButton');
    const croppedImageDataInput = document.getElementById('croppedImageData');

    function showFeedback(message, isError = false) {
      feedbackMessage.textContent = message;
      feedbackMessage.className = `feedback-message text-center text-sm font-normal leading-normal pb-3 pt-1 px-4 ${
        isError ? 'text-red-500' : 'text-[#756388]'
      }`;
      feedbackMessage.classList.remove('hidden');
      setTimeout(() => feedbackMessage.classList.add('hidden'), 4000);
    }

    function openCropModal(imageSrc) {
      cropperImage.src = imageSrc;
      cropModal.classList.add('active');
      cropper = new Cropper(cropperImage, {
        aspectRatio: NaN, // libre, pas fixé
        viewMode: 1,
        autoCropArea: 1,
        movable: true,
        zoomable: true,
        scalable: false,
        responsive: true,
        background: false,
      });
    }

    function closeCropModal() {
      cropModal.classList.remove('active');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
    }

    function enableExtractButton(enable) {
      extractButton.disabled = !enable;
      if (enable) {
        extractButton.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        extractButton.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }

    // Upload or take photo triggers file input click
    uploadButton.addEventListener('click', () => {
      imageInput.accept = 'image/*';
      imageInput.capture = ''; // désactive capture directe (upload)
      imageInput.click();
    });
    takePhotoButton.addEventListener('click', () => {
      imageInput.accept = 'image/*';
      imageInput.capture = 'environment'; // active prise photo appareil
      imageInput.click();
    });

    // On file selected (upload or camera)
    imageInput.addEventListener('change', () => {
      if (imageInput.files && imageInput.files[0]) {
        currentFile = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          openCropModal(e.target.result);
        };
        reader.readAsDataURL(currentFile);
      }
      // Reset input value to allow same file upload again if needed
      imageInput.value = '';
    });

    // Crop modal buttons
    cropCancel.addEventListener('click', () => {
      closeCropModal();
      if (!croppedImageDataInput.value) {
        // Si pas d’image cropée, disable extraction
        enableExtractButton(false);
        previewContainer.classList.add('hidden');
        imagePreview.src = '#';
      }
    });

    cropConfirm.addEventListener('click', () => {
      if (!cropper) return;
      const canvas = cropper.getCroppedCanvas({
        maxWidth: 1024,
        maxHeight: 1024,
        imageSmoothingQuality: 'high',
      });
      if (!canvas) {
        showFeedback('Erreur lors du recadrage de l’image.', true);
        return;
      }
      const base64Data = canvas.toDataURL(currentFile.type || 'image/png');
      croppedImageDataInput.value = base64Data;
      imagePreview.src = base64Data;
      previewContainer.classList.remove('hidden');
      closeCropModal();
      enableExtractButton(true);
    });

    // Clear image button resets everything
    clearImageButton.addEventListener('click', () => {
      currentFile = null;
      croppedImageDataInput.value = '';
      imagePreview.src = '#';
      previewContainer.classList.add('hidden');
      enableExtractButton(false);
      showFeedback('Image supprimée');
    });

    // Optional: dropzone drag and drop support
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-purple-700');
    });
    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-purple-700');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-purple-700');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        currentFile = e.dataTransfer.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          openCropModal(event.target.result);
        };
        reader.readAsDataURL(currentFile);
      }
    });

    // Form submit handler (optional validation)
    document.getElementById('uploadForm').addEventListener('submit', (e) => {
      if (!croppedImageDataInput.value) {
        e.preventDefault();
        showFeedback("Veuillez sélectionner et recadrer une image avant d'extraire.", true);
        return false;
      }
      // Ici tu peux ajouter du code AJAX pour envoyer croppedImageData si tu veux
    });
  </script>
</body>
</html>
